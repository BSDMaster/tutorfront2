<!DOCTYPE html>
<html>

<head>

</head>

<body>
    <div>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="javascript:loadMainPage();">หน้าหลัก</a>
            </li>
            <li class="breadcrumb-item active" id="breadcrumbclass">งานสอนเลขที่ </li>
        </ol>
    </div>
    <br>
    <div class="alert alert-dismissible alert-success" style="display: none;">
        <button type="button" class="close" data-dismiss="alert"></button>
        <strong>บันทึกข้อมูลสำเร็จ</strong>
    </div>
    <div class="alert alert-dismissible alert-danger" style="display: none;">
        <button type="button" class="close" data-dismiss="alert"></button>
        <strong>ไม่สามารถบันทึกข้อมูลได้</strong>
    </div>
    <div class="right">
        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#modalConfirmCancelClsByTutor">ยกเลิกงานสอน</button>
    </div>
    <div class="label-header" id="headerclass">งานสอน</div>
    <div style="margin-top:30px;">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-lg-3">รหัสงานสอน :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsClsId">คณิตศาสตร์</label>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-3">วิชา :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsSubjectCat">คณิตศาสตร์</label>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-3">ภาษาที่ใช้สอน :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsProgram">ปกติ</label>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-3">ค่าแนะนำงานสอน :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsPrice">2000.00</label>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-3">สถานะ :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsStatus">คณิตศาสตร์</label>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="label-header">ข้อมูลนักเรียน</div>
    <div style="margin-top:30px;">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <form class="form-horizontal">
                        <div class="form-group" id="divStuNameSection">
                            <label class="col-lg-3">ชื่อ :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsStuName"></label>
                        </div>
                        <div class="form-group" id="divStuTelSection">
                            <label class="col-lg-3">เบอร์โทรติดต่อ :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsStuTel"></label>
                        </div>
                        <div class="form-group" id="divStuEmailSection">
                            <label class="col-lg-3">อีเมล์ :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsStuEmail"></label>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-3">เพศ :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsStuSex">ชาย</label>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-3">ระดับชั้น :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsLevel">ประถมศึกษาปีที่ 6</label>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-3">สถานศึกษา :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsSchool">โรงเรียน</label>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-3">จำนวนนักเรียน :</label>
                            <label class="col-lg-9 labelnormal" id="lblClsNumOfStudent">1</label>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="label-header">ข้อมูลวัน เวลา สถานที่เรียน</div>
    <div style="margin:30px;">
        <table id="gridClassTime" class="table table-condensed table-hover table-striped scroll">
            <thead>
                <tr>
                    <th data-column-id="day" data-width="10%">วัน</th>
                    <th data-column-id="time" data-width="30%">เวลา</th>
                    <th data-column-id="location" data-width="50%">สถานที่</th>
                    <th data-column-id="map" data-width="10%" data-sortable="false" data-searchable="false">แนะนำเส้นทาง</th>
                </tr>
            </thead>
        </table>
    </div>
    <br>
    <div class="modal fade" id="modalGoogleDirectionClassMap" tabindex="-1" role="dialog" aria-labelledby="modalGoogleDirectionClassLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content contentmap">
                <div class="modal-body mapbody">
                    <div id="divMapClassDetail" class="map"></div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <!-- Modal -->
    <div class="modal fade" id="modalConfirmCancelClsByTutor" tabindex="-1" role="dialog" aria-labelledby="confirmCancelClsByTutorLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="confirmCancelClsByTutorLabel">แจ้งขอยกเลิกงานสอน</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                </div>
                <div class="modal-body">
                    <div id="divConfirmCancelClsByTutorLabel">
                        กรุณาระบุสาเหตุของของการยกเลิกงานสอน และกดปุ่ม "ยืนยันขอยกเลิกงานสอน" หากท่านต้องการยืนยันการขอยกเลิกงานสอน สถาบันได้จำกัดการยกเลิกงานสอน
                        หากท่านขอยกเลิกงานสอนเกินกว่าจำนวนครั้งที่สถาบันกำหนด ท่านไม่ได้รับการแนะนำงานสอนใหม่ กรุณาติดต่อทางสถาบันเพื่อทำการปลดล็อค
                    </div>
                    <div class="form-group">
                        <label for="reasonCancelClsByTutorTextarea">สาเหตุที่ขอยกเลิกงานสอน</label>
                        <textarea class="form-control" id="reasonCancelClsByTutorTextarea" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary btn-lg" onClick="javascript:cancelClsByTutor();">ยืนยันขอยกเลิกงานสอน</button>
                </div>
            </div>
        </div>
    </div>
    <br>
</body>
<script>
    var _mapClassDetail;
    var _directionsDisplayClassDetail;
    var _timesClassDetail = [];
    jQuery(document).ready(function () {
        initialClassDetailData();
    });

    var gridClassTime = $("#gridClassTime").bootgrid({
        navigation: 0,
        labels: {
            noResults: 'ไม่พบรายการ'
        }
    }).on("loaded.rs.jquery.bootgrid", function () {
        gridClassTime.find(".command-open").on("click", function (e) {
            var i = parseInt($(this).data("row-id"));
            openMapClassDetail(i);
        });
    });

    function initialClassDetailData() {

        $.ajax({
            type: "GET",
            url: _gServiceURL + "class/classdetail/tutor/" + _gSelectedClsId,
            contentType: "application/json; charset=utf-8",
            crossDomain: true,
            dataType: "json",
            success: function (data, status, jqXHR) {

                var classDetail = data.data.classDetailView;
                console.log(classDetail);
                $('#breadcrumbclass').text('งานสอนเลขที่ ' + classDetail.clsId);
                $('#headerclass').text('งานสอนเลขที่ ' + classDetail.clsId);
                if (classDetail.statusId == 6) {
                    $('#divStuNameSection').hide();
                    $('#divStuTelSection').hide();
                    $('#divStuEmailSection').hide();
                } else {
                    $('#divStuNameSection').show();
                    $('#divStuTelSection').show();
                    $('#divStuEmailSection').show();
                }
                $('#lblClsClsId').text(classDetail.clsId);
                $('#lblClsStatus').text(classDetail.statusName);
                $('#lblClsSubjectCat').text(classDetail.subjectAndGroupDetailName);
                $('#lblClsProgram').text(classDetail.program);
                $('#lblClsPrice').text(classDetail.recPrice);
                $('#lblClsStuSex').text(classDetail.stuSex);
                $('#lblClsLevel').text(classDetail.stuLevel);
                $('#lblClsSchool').text(classDetail.stuSchool);
                $('#lblClsNumOfStudent').text(classDetail.numOfStu);
                $('#lblClsStuName').text(classDetail.stuName);
                $('#lblClsStuTel').text(classDetail.stuTel);
                $('#lblClsStuEmail').text(classDetail.stuEmail);
                _timesClassDetail = classDetail.recommendTimelocationList;
                for (var i = 0; i < _timesClassDetail.length; i++) {
                    appendClassTime(_timesClassDetail[i], i);
                }
                initclassdetailmap();
            },
            error: function (jqXHR, status) {
            }

        });

    }

    function appendClassTime(time, i) {
        gridClassTime.bootgrid("append", [
            {
                "day": time.day,
                "time": time.time,
                "location": time.location,
                "map": "<button type='button' class='btn btn-xs btn-default command-open' data-row-id='" + i + "'><div class='fa-waypoint'></div></button> "
            }
        ]);
    }
    function initclassdetailmap() {
        _directionsDisplayClassDetail = new google.maps.DirectionsRenderer();
        var latLog = new google.maps.LatLng(13.736334, 100.531102);
        _mapClassDetail = new google.maps.Map(document.getElementById('divMapClassDetail'), {
            center: latLog,
            zoom: 15
            //,disableDefaultUI: true
        });
        _directionsDisplayClassDetail.setMap(_mapClassDetail);
    }


    function openMapClassDetail(id) {
        console.log("OPENMAP");
        var time = _timesClassDetail[id];
        var travelMode = 'DRIVING';
        if (time.travelType == 'T') {
            travelMode = 'TRANSIT';
        }
        console.log(time);
        var startlatLog = new google.maps.LatLng(time.startLat, time.startLong);
        var endlatLog = new google.maps.LatLng(time.latitude, time.longitude);
        var directionsService = new google.maps.DirectionsService();

        directionsService.route({
            origin: startlatLog,
            destination: endlatLog,
            travelMode: travelMode
        }, function (response, status) {
            if (status === 'OK') {
                console.log("direction display");
                console.log(_mapClassDetail);

                _directionsDisplayClassDetail.setDirections(response);
                setTimeout(function () {
                    //your code to be executed after 1 second
                    _mapClassDetail.setZoom(12);
                }, 1000);
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });

        $("#modalGoogleDirectionClassMap").modal('show');

    }
    function cancelClsByTutor() {
        console.log("cancel class by tutor");
        var reason = $('#reasonCancelClsByTutorTextarea').val();
        if (_gUser.turId != null && reason != null && reason != "") {
            var bodyRequest = {
                clsId: parseInt(_gSelectedClsId),
                requester: _gUser.turName,
                reason: reason
            };
            console.log(bodyRequest);
            $.ajax({
                type: "POST",
                url: _gServiceURL + "classrequest/requesttocancelbytutor/",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(bodyRequest),
                crossDomain: true,
                dataType: "json",
                success: function (data, status, jqXHR) {
                    var alert;
                    var msg = data.message;
                    if (data.status == 200) {
                        alert = $(".alert-success");
                    } else {
                        alert = $(".alert-danger");
                    }
                    alert.find("strong").text(msg);
                    alert.show();
                },
                error: function (jqXHR, status) {
                    var alert = $(".alert-danger");
                    alert.find("strong").text(jqXHR);
                    alert.show();
                }
            });
        } else {
            var alert = $(".alert-danger");
            alert.find("strong").text('กรุณากรอกข้อมูลให้ครบถ้วน');
            alert.show();
        }
        $("#modalConfirmCancelClsByTutor").modal('hide');
    }


</script>

</html>